<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Дашборд - Language Flash</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<section class="content-section">
    <div class="container">
        <h1>Добро пожаловать, <span th:text="${user.firstName}"></span>!</h1>

        <!-- Кнопка для выбора программы -->
        <div class="mb-4">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#programModal">
                Выбрать программу
            </button>
        </div>

        <!-- Информация о программе -->
        <div th:if="${settings['language'] != null}" class="mb-4">
            <h3>Ваша программа</h3>
            <p>Язык: <span th:text="${settings['language']}"></span></p>
            <p>Уровень: <span th:text="${settings['minLevel']}"></span></p>
            <p>Темы: <span th:text="${tagRussianNames != null and !tagRussianNames.isEmpty() ? #strings.listJoin(tagRussianNames, ', ') : 'Нет тем'}"></span></p>
        </div>

        <!-- Прогресс -->
        <div class="mb-4">
            <h3>Ваш прогресс</h3>
            <p>Активных слов: <span th:text="${progressCount}"></span></p>
            <p>Выученных слов: <span th:text="${learnedCount}"></span></p>
            <a href="/learn" class="btn btn-primary" th:classappend="${settings['language'] == null ? 'disabled' : ''}">Карточки</a>
            <a href="/learn/fast" class="btn btn-secondary ms-2" th:classappend="${settings['language'] == null ? 'disabled' : ''}">Флеш-запоминание</a>
        </div>

        <!-- Активные слова -->
        <div th:if="${activeWords != null and !activeWords.isEmpty()}">
            <h3>Активные слова</h3>
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Слово</th>
                    <th>Перевод</th>
                    <th>Прогресс</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="progress : ${activeWords}">
                    <td th:text="${progress.word.word}"></td>
                    <td th:text="${progress.word.translation}"></td>
                    <td th:text="${#numbers.formatDecimal(progress.knowledgeFactor, 1, 2)}"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Выученные слова -->
        <div th:if="${learnedWords != null and !learnedWords.isEmpty()}">
            <h3>Выученные слова</h3>
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Слово</th>
                    <th>Перевод</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="progress : ${learnedWords}">
                    <td th:text="${progress.word.word}"></td>
                    <td th:text="${progress.word.translation}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- Модальное окно для выбора программы -->
<div class="modal fade" id="programModal" tabindex="-1" aria-labelledby="programModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="programModalLabel">Выбрать программу</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form th:action="@{/dashboard/update-settings}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="language" class="form-label">Язык</label>
                        <select class="form-select" id="language" name="language" required onchange="loadLevels(this.value)">
                            <option value="" disabled selected>Выберите язык</option>
                            <option th:each="lang : ${languages}" th:value="${lang.name}" th:text="${lang.name}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="minLevel" class="form-label">Минимальный уровень</label>
                        <select class="form-select" id="minLevel" name="minLevel" required disabled>
                            <option value="" disabled selected>Сначала выберите язык</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Темы (выберите несколько)</label>
                        <div class="row">
                            <div class="col-md-4" th:each="tag : ${tags}">
                                <div class="card mb-2 tag-card" th:style="'background-color: ' + ${tag.color}"
                                     onclick="toggleTag(this)" th:data-tag="${tag.name()}">
                                    <div class="card-body text-center">
                                        <img th:if="${tag.imageUrl != null}" th:src="@{${tag.imageUrl}}" class="img-fluid mb-2"
                                             th:alt="${tag.russianName}" style="max-height: 50px;">
                                        <p class="mb-0" th:text="${tag.russianName}"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="tags" name="tags" th:value="${settings['tags'] != null ? #strings.listJoin(settings['tags'], ', ') : ''}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function loadLevels(languageName) {
        const minLevelSelect = document.getElementById('minLevel');
        minLevelSelect.innerHTML = '<option value="" disabled selected>Загрузка...</option>';
        minLevelSelect.disabled = true;

        fetch(`/dashboard/levels?language=${encodeURIComponent(languageName)}`)
            .then(response => response.json())
            .then(levels => {
                minLevelSelect.innerHTML = '<option value="" disabled selected>Выберите уровень</option>';
                levels.forEach(level => {
                    const option = document.createElement('option');
                    option.value = level;
                    option.text = level;
                    minLevelSelect.appendChild(option);
                });
                minLevelSelect.disabled = false;
            })
            .catch(error => {
                console.error('Ошибка загрузки уровней:', error);
                minLevelSelect.innerHTML = '<option value="" disabled selected>Ошибка загрузки</option>';
            });
    }
</script>
<script>
    let selectedTags = new Set();

    function toggleTag(card) {
        const tag = card.getAttribute('data-tag');
        if (selectedTags.has(tag)) {
            selectedTags.delete(tag);
            card.classList.remove('selected');
        } else {
            selectedTags.add(tag);
            card.classList.add('selected');
        }
        document.getElementById('tags').value = Array.from(selectedTags).join(',');
    }

    document.addEventListener('DOMContentLoaded', function () {
        const tagsInput = document.getElementById('tags');
        const initialTags = tagsInput.value ? tagsInput.value.split(',') : [];
        initialTags.forEach(tag => {
            const card = document.querySelector(`.tag-card[data-tag="${tag}"]`);
            if (card) {
                selectedTags.add(tag);
                card.classList.add('selected');
            }
        });
    });
</script>
</body>
</html>